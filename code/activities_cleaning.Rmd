---
title: "Athlete Activities Cleaning"
author: "Peter Bonner"
date: "15/04/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE,
                      message = FALSE,echo = TRUE, dpi = 180,
                      fig.width = 8, fig.height = 5)


```

## Libraries
```{r}
library(tidyverse)
library(readr)
library(janitor)
library(readxl)
library(lubridate)
library(ggthemr)
ggthemr("fresh")

```

## Data Cleaning


##### Read data
```{r read-data}
activities <- read_csv("data/activities.csv")

```

```{r dataframe structure}
str(activities_var)
```

```{r add-variables}

# Add additional variables
activities_var <- activities %>%
  mutate(date = as_date(date),
                year = year(date),
                quarter = quarter(date),
                week = week(date)) %>%
  mutate(workout_time_min = workout_time/60)

```

##### Data Distributions

```{r activities-per-year-vis}
options(scipen = 999)

# View number of uploaded activites per year
activities %>%
  filter(sport == "Bike") %>%
  ggplot(aes(x = factor(year))) +
  geom_histogram(binwidth = 1, stat = "count") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Activities uploaded per year",
       x = "Year") 
  
```

```{r male-female}
activities %>%
  group_by(gender) %>%
  summarise(gender_count = n())

# As percentage
activities %>%
  group_by(gender) %>%
  summarise(count = n() ) %>%
  mutate( prop = count / sum(count) )

```

##### Filter Data

Create additional or mutate existing variables to assist in filtering and initial plotting
```{r filter-data}
activities_filtered <- activities_var %>%
  # keep only bike activities
  filter(sport == "Bike") %>%
  # keep only females
  filter(gender == "M") %>%
  # 2015 onwards - more accessible and reliable power meters on bikes & increase in uploads
  filter(year >= 2015) %>%
  # standard for research
  filter(age >= 18 & age <= 60) %>%
  # remove workout_time less than 10 seconds and more than 12 hours
  filter(workout_time >= 10 & workout_time <= 43200) %>%
  # remove speed > 65 kph (pro cyclist max sprint speed)
  filter(average_speed <= 65) %>%
  # indicate virtual power algorithm
  filter(`1s_critical_power` != 2000,
         `1s_critical_power` != 1000) %>%
  # remove absolute power values above 99th percentile for both genders
  pivot_longer(cols = `1s_critical_power`:`30m_critical_power`,
               names_to = "duration_s",
               values_to = "power_output") %>%
  group_by(gender,duration_s) %>%
  mutate(row = row_number()) %>%
  filter(power_output <= quantile(power_output, 0.99, na.rm = TRUE)) %>%
  pivot_wider(names_from = duration_s,
              values_from = power_output) %>%
  select(-row) %>%
  ungroup()

         
```

## Data Manipulation

##### Quarterly best MMPs

```{r quarter-best-mmp}
# Extract best MMP values for each quarter per year 
activities_quarters <- activities_filtered %>%
  group_by(id,year,quarter) %>%
  summarise(across(c(`3m_critical_power`:`10m_critical_power`), max),.groups = "keep")

# Bring back age and gender
```


##### Critical power model

```{r critical-power}
library(tidymodels)
# Convert to long format
activities_quarters_long <- activities_quarters %>%
  dplyr::rename(`180` = `3m_critical_power`,
                `300` = `5m_critical_power`,
                `480` = `8m_critical_power`,
                `600` = `10m_critical_power`) %>%
  pivot_longer(`180`:`600`, names_to = "duration_s", values_to = "power_output") %>%
  mutate(duration_s = as.numeric(duration_s),
    work_done = duration_s * power_output) %>%
  drop_na()

# Nest model data 
activities_quarters_nest <- activities_quarters_long %>%
  group_by(id,year,quarter) %>%
  nest(data = c(duration_s,power_output,work_done))

# iterate linear cp model
cp_model <- activities_quarters_nest %>%
  mutate(model = map(data, ~lm(work_done ~ duration_s, data = .x)))

## iterate over the model with the function tidy (which puts lm output into tidy format) & unnest coeffs to extract cp & wprime into separate columns

activities_cp <- cp_model %>%
  rowwise() %>% 
  mutate(
    coefs = broom::tidy(model) %>% list()
  ) %>% 
  ungroup() %>% 
  select(id, year,quarter,coefs) %>% 
  unnest(cols = coefs) %>% 
  mutate(
    term = ifelse(term == "(Intercept)", "w_prime", "critical_power")
  ) %>% 
  select(id:std.error) %>% 
  pivot_longer(cols = c("estimate", "std.error")) %>% 
  mutate(
    term = ifelse(name == "estimate", term, paste(term, "error", sep = "_"))
  ) %>% 
  select(-name) %>% 
  pivot_wider(names_from = term) %>% 
  left_join(x = activities_filtered, 
            y = .,
            by = c("id", "year","quarter")) %>% 
  ## Remove dodgy wprime and cp values
  filter(w_prime > 1000,
         w_prime < 50000) %>%
  filter(critical_power > 100,
         critical_power < 500)

```

```{r power-duration-distribution}

ggplot(activities_cp,
       aes(x = critical_power)) +
  geom_histogram(binwidth = 5) +
  labs(title = "Critical Power distribution in males",
       x = "Critical Power (W)")

ggsave(path = "plots", filename = "cp_dist.png")
  

ggplot(activities_cp,
       aes(x = w_prime)) +
  geom_histogram(binwidth = 1000) +
  labs(title = "W' distribution in males",
       x = "W' (J)")

ggsave(path = "plots", filename = "wprime_dist.png")

```

##### Remove unwanted data frames

```{r}
remove(activities)
remove(activities_var)
remove(activities_filtered)
remove(activities_quarters)
remove(activities_quarters_long)
remove(activities_quarters_nest)
remove(cp_model)
```

##### Quarterly best training metrics

```{r cp-quartiles + hw-pwr-ratio }
rides <- activities_cp %>%
  relocate(year:`30m_critical_power`,
           .after = where(is.character)) %>%
  mutate(year = as.factor(year)) %>%
  mutate(quarter = as.factor(quarter)) %>%
  mutate(cp_quantile = ntile(critical_power,4)) %>%
  mutate(pwr_hr_ratio = average_power / average_hr) %>%
  select(-X34)
```


```{r cp-quartile-vis}
library(gghalves)
library(ggdist)

ggplot(rides, aes(x = as.factor(cp_quantile), y = critical_power)) +
  stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = 0,
    justification = -0.3) +
  geom_point(
    size = 1.3,
    alpha = 0.15,
    position = position_jitter(
      seed = 1, width = 0.1)
  ) +
  geom_boxplot(
    width = 0.25,
    outlier.shape = NA
  ) +
  labs(title = "Critical power quartiles",
       x = "Quartile",
       y = "Critical Power (W)")

ggsave(path = "plots", filename = "cp_quartile_dist.png")


```


```{r volume-by-week}
# Weekly training metrics
week_total_volume <- rides %>%
  group_by(id,year,quarter,week) %>%
  summarise(across(c("workout_time_min","total_distance","elevation_gain","total_work", "coggan_tss"), ~sum(.x, na.rm = TRUE),.names = "week_{.col}"),.groups = "keep") %>%
  dplyr::rename(week_total_workout_time = week_workout_time_min,
                week_total_elevation_gain = week_elevation_gain,
                week_total_tss = week_coggan_tss) %>%
  ungroup()
```


```{r intensity-by-week}
week_avg_int <- rides %>%
  # calculate relative session intensity
  mutate(relative_intensity = average_power / critical_power) %>%
  # calculate weekly averages
  group_by(id,year,quarter,week) %>%
  summarise(across(c(average_speed:coggan_if,relative_intensity,pwr_hr_ratio), ~ mean(.x, na.rm = TRUE),.names = "week_{.col}"),.groups = "keep") %>%
  ungroup()
```


```{r all-week-metrics}
weekly_metrics <- full_join(week_total_volume, week_avg_int, by = c("id", "year", "quarter", "week"))
```


```{r metrics-quarter}

quarter_metrics <- weekly_metrics %>%
  group_by(id,year,quarter) %>%
  summarise(across(c(week_total_workout_time:week_pwr_hr_ratio), ~ mean(.x, na.rm = TRUE)),.groups = "keep") %>%
  ungroup()

# join with cp metrics
cp_metrics <- rides %>%
  select(id,age,year,quarter, gender,critical_power,w_prime,critical_power_error,w_prime_error,cp_quantile) %>%
  unique()

ride_metrics <- full_join(quarter_metrics, cp_metrics, by = c("id","year","quarter")) %>%
  drop_na()

``` 

###### Training metric plots

**Weekly average training volume and intensity by quartile**

Weekly averages are calculated per quarter (3 month period)

```{r metrics-vis-1}
ggplot(ride_metrics,
       aes(x = week_total_workout_time)) +
  geom_histogram(binwidth = 15) +
  labs(title = "Weekly training duration",
       x = "Weekly training duration (minutes)")

ggsave(path = "plots", filename = "training_mins_dist.png")


```

```{r metrics-vis-2}

ggplot(ride_metrics,
       aes(x = week_relative_intensity)) +
  geom_histogram(binwidth = 0.05) +
  labs(title = "Weekly relative training intensity",
       x = "Proportion of critical power")

ggsave(path = "plots", filename = "rel_int_dist.png")

```

```{r volume-by-quartile}
ggplot(ride_metrics, aes(x = as.factor(cp_quantile), y = week_total_workout_time)) +
  stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = 0,
    justification = -0.3) +
  geom_point(
    size = 1.3,
    alpha = 0.15,
    position = position_jitter(
      seed = 1, width = 0.1)
  ) +
  geom_boxplot(
    width = 0.25,
    outlier.shape = NA
  ) +
  labs(title = "Weekly training volume",
       x = "Quartile",
       y = "Average minutes per week")

ggsave(path = "plots", filename = "vol_by_quartile.png")
```

```{r intensity-by-quartile}

ggplot(ride_metrics, aes(x = as.factor(cp_quantile), y = week_relative_intensity)) +
  stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = 0,
    justification = -0.3) +
  geom_point(
    size = 1.3,
    alpha = 0.15,
    position = position_jitter(
      seed = 1, width = 0.1)
  ) +
  geom_boxplot(
    width = 0.25,
    outlier.shape = NA
  ) +
  labs(title = "Weekly training intensity",
       x = "Quartile",
       y = "Proportion of critical power")

ggsave(path = "plots", filename = "rel_int_by_quartile.png")
```


```{r total-tss-quartile}
ggplot(ride_metrics, aes(x = as.factor(cp_quantile), y = week_total_tss)) +
  stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = 0,
    justification = -0.3) +
  geom_point(
    size = 1.3,
    alpha = 0.15,
    position = position_jitter(
      seed = 1, width = 0.1)
  ) +
  geom_boxplot(
    width = 0.25,
    outlier.shape = NA
  ) +
  labs(title = "Weekly total training load",
       x = "Quartile",
       y = "Training Stress Score (AU)")

ggsave(path = "plots", filename = "total_tss_by_quartile.png")
```


## Write to rds file
```{r}
write_rds(x = activities_cp,
          file = "data/activities_cp.rds")
```




