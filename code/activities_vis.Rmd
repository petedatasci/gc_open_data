---
title: "Activities CP - Vis and Analysis"
author: "Peter Bonner"
date: "19/04/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE,
                      message = FALSE,echo = TRUE, dpi = 180,
                      fig.width = 8, fig.height = 5)


```

```{r}
library(tidyverse)
library(readr)
library(janitor)
library(readxl)
library(lubridate)
theme_set(theme_minimal())
library(GGally)
library(broom)

options(scipen = 999)
```


## Read in activities data
```{r}
activities_cp <- read_rds("~/R/gc_open_data/data/activities_cp.rds") %>%
  relocate(year:`30m_critical_power`,
           .after = where(is.character)) %>%
  mutate(year = as.factor(year)) %>%
  select(-X34)


```

# Training metrics by quarter

```{r}
# Quarterly totals for volume measures
quarter_totals <- activities_cp %>%
  mutate(year = as.factor(year)) %>%
  group_by(id,year,quarter) %>%
  summarise(across(c("workout_time_min","total_distance","elevation_gain","total_work"), ~ sum(.x, na.rm = TRUE),.names = "total_{.col}"),.groups = "keep")

# quarter averages for intensity measures
quarter_averages <- activities_cp %>%
  mutate(year = as.factor(year)) %>%
  group_by(id,year,quarter) %>%
  summarise(across(c(average_speed:coggan_tss), ~ mean(.x, na.rm = TRUE),.names = "average_{.col}"),.groups = "keep") %>%
  ungroup()

# join tibbles 
quarter_joined <- quarter_totals %>%
  full_join(quarter_averages)

activities_cp_trim <- activities_cp %>%
  select(id,age,year,quarter, gender,critical_power,w_prime,critical_power_error,w_prime_error) %>%
  unique()
  
activity_metrics <- activities_cp_trim %>%
  full_join(quarter_joined, by = c("id","year","quarter"))
  
```

# Dimensionality reduction: Principle component analysis

```{r}
# Method 1 - tidy models (AH)
library(tidymodels)

pca_df <- activity_metrics %>%
  mutate(quarter = as.factor(quarter)) %>%
  mutate(cp_quantile = ntile(critical_power,4)) %>%
  select(-id,-year,-quarter,-critical_power,-w_prime,-critical_power_error,-w_prime_error)

pca_recipe <- recipe(~ ., data = pca_df) %>%
  update_role(gender,cp_quantile, new_role = "id") %>%
  step_naomit(all_predictors()) %>%
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors(), num_comp = 6, id = "pca")
  
pca_prep <- prep(pca_recipe)

cycling_pca <- pca_prep %>%
  tidy(id = "pca")

cycling_pca

bake(pca_prep, new_data = NULL)

```

```{r}
# bake recipe

bake(pca_prep, new_data = NULL)
```


We can also apply the `recipes::tidy()` method to the output from `recipes::step_pca()` to examine how much variance each component accounts for:

```{r}
pca_prep %>%
  tidy(id = "pca", type = "variance") %>%
  filter(terms == "percent variance") %>%
  ggplot(aes(x = component, y = value)) +
  geom_col(fill = "#b6dfe2") + 
  xlim(c(0, 10)) + 
  ylab("% of total variance")
```

We can plot these loadings by principal component too, following Julia Silgeâ€™s example:

```{r}
# Plot loadings

cycling_pca %>%
    mutate(terms = tidytext::reorder_within(terms, 
                                          abs(value), 
                                          component)) %>%
  ggplot(aes(abs(value), terms, fill = value > 0)) +
  geom_col() +
  facet_wrap(~component, scales = "free_y") +
  tidytext::scale_y_reordered() +
  scale_fill_manual(values = c("#b6dfe2", "#0A537D")) +
  labs(
    x = "Absolute value of contribution",
    y = NULL, fill = "Positive?"
  ) 
```

### Plot PCA loadings + scores
We have the PCA loadings in `cycling_pca`. But we need them in a wide format now for plotting.

```{r}
# get pca loadings into wider format
pca_wider <- cycling_pca %>% 
  tidyr::pivot_wider(names_from = component, id_cols = terms)
```

We also need to go back to our prepped cycling recipe, `pca_prep`, and `recipes::juice()` it to get the PCA scores back.

```{r}
library(ggrepel)
#PCA 1 vs PCA 2
# define arrow style
arrow_style <- arrow(
  angle = 20, length = grid::unit(8, "pt"),
  ends = "first", type = "closed"
)

pca_plot <-
  bake(pca_prep, new_data = NULL) %>%
  ggplot(aes(PC1, PC2)) +
  geom_point(aes(colour = factor(cp_quantile), shape = factor(cp_quantile)), 
             #alpha = 0.4, 
             size = 2) +
  scale_colour_manual(values = c("darkorange","purple","cyan4","midnightblue")) +
  scale_shape(solid = FALSE)

pca_plot +
  geom_segment(data = pca_wider,
               aes(xend = PC1, yend = PC2), 
               x = 0, 
               y = 0, 
               arrow = arrow_style) + 
  geom_text_repel(data = pca_wider,
            aes(x = PC1, y = PC2, label = terms), 
            xlim = c(-Inf, Inf), ylim = c(-Inf, Inf),
            size = 5, 
            color = "black") 

pca_plot

# PCA 1 vs PCA 3
pca_plot_2 <-
  bake(pca_prep, new_data = NULL) %>%
  ggplot(aes(PC1, PC3)) +
  geom_point(aes(colour = factor(cp_quantile), shape = factor(cp_quantile)), 
             #alpha = 0.4, 
             size = 2) +
  scale_colour_manual(values = c("darkorange","purple","cyan4","midnightblue")) +
  scale_shape(solid = FALSE)

pca_plot_2 +
  geom_segment(data = pca_wider,
               aes(xend = PC1, yend = PC3), 
               x = 0, 
               y = 0, 
               arrow = arrow_style) + 
  geom_text_repel(data = pca_wider,
            aes(x = PC1, y = PC3, label = terms), 
            xlim = c(-Inf, Inf), ylim = c(-Inf, Inf),
            size = 5, 
            color = "black") 
```







# Julia Silge
```{r}
# output

bake(pca_prep, new_data = NULL)

bake(pca_prep,new_data = NULL) %>% # normally would use testing data, but only using on this data set so set to null
  ggplot(aes(PC1,PC2)) +
  geom_point(colour = "midnightblue", alpha = 0.7, size = 2)
```


```{r}
# Method 2
pca_fit <- activity_metrics %>%
  select(where(is.numeric)) %>% # retain numeric columns
  drop_na() %>% # need to remove all Na values
  scale() %>% # scale to zero mean and unit variance
  prcomp() # do PCA


arrow_style <- arrow(
  angle = 20, length = grid::unit(4, "pt"),
  ends = "first", type = "closed"
)

pca_fit %>%
  # extract rotation matrix
  tidy(matrix = "rotation") %>%
  pivot_wider(
    names_from = "PC", values_from = "value",
    names_prefix = "PC"
  ) %>%
  ggplot(aes(PC1, PC2)) +
  geom_segment(
    xend = 0, yend = 0,
    arrow = arrow_style
  ) +
  geom_text(aes(label = column),hjust = 1) +
  xlim(-1.5,0.5) +
  ylim(-1,1) +
  coord_fixed()

```

```{r}
pca_fit %>%
  # extract eigenvalues
  tidy(matrix = "eigenvalues") %>%
  ggplot(aes(PC, percent)) +
  geom_col() +
  scale_x_continuous(
    # create one axis tick per PC
    breaks = 1:18
  ) +
  scale_y_continuous(
    name = "variance explained",
    # format y axis ticks as percent values
    label = scales::label_percent(accuracy = 1)
  )
```








# Training metrics vs CP
```{r}
# Training duration
quarter_metrics %>%
  filter(total_workout_time <= 1000000) %>%
  ggplot(aes(x = total_workout_time, y = critical_power)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm",colour = "blue")

# Training distance
quarter_metrics %>%
  filter(total_total_distance >0 & total_total_distance <= 20000) %>%
  ggplot(aes(x = total_total_distance, y = critical_power)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm",colour = "blue")

# Average power 
quarter_metrics %>%
    ggplot(aes(x = average_average_power, y = critical_power)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm",colour = "blue")

# Average HR
quarter_metrics %>%
  filter(average_average_hr > 50) %>%
  ggplot(aes(x = average_average_hr, y = critical_power)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm",colour = "blue")
```

```{r}

```





## Average change in CP over time

```{r}
cp_stats <- activities_cp
# calculate % change in cp/w_prime for each quarter per person
  group_by(id) %>%
  arrange(year, quarter, .by_group = TRUE) %>%
  mutate(cp_pct_change = (critical_power / lag(critical_power)-1)*100,
         w_prime_pct_change = (w_prime / lag(w_prime)-1)*100)

# change in cp per quarter
cp_stats %>%
  filter(year > 1999 & year <= 2021) %>%
  group_by(year) %>%
  summarise(avg_change = mean(cp_pct_change, na.rm = TRUE)) %>%
  arrange(avg_change) %>%
  ggplot(aes(x = factor(year), y = avg_change)) +
  geom_col(fill = "#f03b20", alpha = 0.5) +
  labs(title = "Average percent change in critical power per quarter",
       x = NULL,
       y = NULL)

# change in wprime per quarter
cp_stats %>%
  filter(year > 1999 & year <= 2021) %>%
  group_by(year) %>%
  summarise(avg_change = mean(w_prime_pct_change, na.rm = TRUE)) %>%
  arrange(avg_change) %>%
  ggplot(aes(x = factor(year), y = avg_change)) +
  geom_col(fill = "#f03b20", alpha = 0.5) +
  labs(title = "Average percent change in W' per quarter",
       x = NULL,
       y = NULL)

```